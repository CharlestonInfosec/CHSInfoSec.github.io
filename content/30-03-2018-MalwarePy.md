Title: Reversing py2exe executables
Date: 2018-03-30 00:00
Modified: 2018-03-30 00:00
Category: malware
Tags: malware, reverse_engineering, python
Illustration: malwarepy.jpeg
Slug: reversing-py2exe
Authors: TJ Nelson
Summary: This blog post will discuss how to reverse py2exe malware.

# Reversing Python (py2exe) Malware
This post will be based on a CHSinfoSec Meetup in March 2018. The Slides from this talk are here:

[Reversing Python Malware Slides](https://docs.google.com/presentation/d/1zBMxeLYEnb2uZE-sYf4v-dovIjEyUm0HWmCB26stiBk/edit?usp=sharing)

The sample from this example is CannibalRAT (sha256):83d49f14ebb6641f1b813614a40e7df2d200096b8aae198e6298125f47b55b59

You can download it [HERE](https://malshare.com/sample.php?action=detail&hash=fb1a2d0db81979e09128630bc2c82c53) **BEWARE THIS IS MALWARE**

You can also review the original analysis of this sample here:[http://blog.   talosintelligence.com/2018/02/cannibalrat-targets-brazil.html] (http://blog.talosintelligence.com/2018/02/cannibalrat-targets-brazil.html)


Below you will find the source code for the scripts used as well as links to videos showing the process.

### Extract Additional Imports from PE Overlays

get_overlay.py:

    import pefile
    import sys

    filename = sys.argv[1]
    with open(filename, "rb") as s:
        r = s.read()

    pe = pefile.PE(filename)
    offset = pe.get_overlay_data_start_offset()

    with open(filename + ".app", "wb") as t:
        t.write(r[offset:])
 
 *\[command\]* python get_overlay.py *<filename\>*
 
 [![asciicast](https://asciinema.org/a/jDo4WujW1HiHTAKYkZFdY8T78.png)](https://asciinema.org/a/jDo4WujW1HiHTAKYkZFdY8T78)
 
 
 
 ### Extract resources from PE file using wrestool
 
 *\[command\]* wrestool -Rax *<filename\>* -o *output_folder\>*
 
 [![asciicast](https://asciinema.org/a/171998.png)](https://asciinema.org/a/171998)
 
 ### Extract main python files from PYTHONSCRIPT
 
 
 unpack_pythonscript.py:
 
    import marshal, imp, sys

    def main():
        f = open(sys.argv[1], "rb")
        f.seek(17)
        print "==skipping_header=="

        unmarshal = marshal.load(f)

        for i in range(0, len(unmarshal)):
            open(str(i) + ".pyc", "wb").write(imp.get_magic() + '\0' * 4 + marshal.dumps(unmarshal[i]))

        f.close()
        print "==done=="

    if __name__ == "__main__":
        main()
        
*\[command\]* python unpack_pythonscript.py *<filename\>*

[![asciicast](https://asciinema.org/a/172001.png)](https://asciinema.org/a/172001)

### Decompile .pyc files with uncompyle6

*\[command\]* uncompyle6 *<filename\>* \> *<filename\>.py*

[![asciicast](https://asciinema.org/a/171997.png)](https://asciinema.org/a/171997)
## Putting it all together
This is the process of decompiling Cannibal RAT and extracting the C2 information from the Python source code.
WARNING: Those urls are dangerous and should not be navigated to.

For more information take a look at http://blog.talosintelligence.com/2018/02/cannibalrat-targets-brazil.html

[![asciicast](https://asciinema.org/a/172072.png)](https://asciinema.org/a/172072)
